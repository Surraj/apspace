<ion-content>
  <!-- MAIN GRID -->
  <div>
    <!-- MAIN ROW -->
    <div class="masonry-list" [dragula]="editableList">
      <!-- PROFILE SECTION -->
      <div class="masonry-item no-drag">
        <ion-card no-margin>
          <ion-card-header no-padding>
            <ion-grid>
              <ion-row>
                <ion-col>
                  <ion-avatar class="dashboard-avatar cursor-pointer float-left" (click)="navigateToPage('profile')">
                    <img [src]="'data:image/jpg;base64,' + (photo$ | async).base64_photo"
                      onerror="this.src='assets/img/no_img.png'" alt="Avatar">
                  </ion-avatar>
                  <ng-template #loadingStudentsPhoto>
                    loading picture
                  </ng-template>
                  <div class="welcome-message-wrapper float-left"
                    *ngIf="studentFirstName$ | async as studentFirstName; else loadingProfile" padding-start>
                    <ion-card-title>
                      <h3 class="responsive-h1">{{greetingMessage}}, <span>{{studentFirstName | titlecase}}</span>
                      </h3>
                    </ion-card-title>
                    <ion-card-subtitle>
                      <h3 class="responsive-h2">Nice to see you again.</h3>
                    </ion-card-subtitle>
                  </div>
                  <ng-template #loadingProfile>
                    <div class="welcome-message-wrapper float-left" style="width: 75%; padding-top: 0" padding-start>
                      <ion-card-title>
                        <h3 class="responsive-h1">
                          <ion-skeleton-text animated style="width: 100%; line-height: 30px"></ion-skeleton-text>
                        </h3>
                      </ion-card-title>
                      <ion-card-subtitle>
                        <h3 class="responsive-h2">
                          <ion-skeleton-text animated style="width: 75%; line-height: 25px"></ion-skeleton-text>
                        </h3>
                      </ion-card-subtitle>
                    </div>
                  </ng-template>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>
                  <div class="icons" margin-top text-right>
                    <a (click)="toggleReorderingMode()">
                      <ion-icon *ngIf="editableList" color="success" class="responsive-icon colored-text"
                        name="checkmark"></ion-icon>
                      <ion-icon *ngIf="!editableList" class="responsive-icon colored-text" name="md-create"></ion-icon>
                    </a>
                    <a (click)="navigateToPage('/settings')" margin-start margin-end>
                      <ion-icon class="anim-rotate-360-deg animated responsive-icon colored-text" name="settings">
                      </ion-icon>
                    </a>
                    <a class="notifications" (click)="navigateToPage('/notifications')">
                      <ion-badge *ngIf="numberOfUnreadMsgs > 0" color="danger">{{ numberOfUnreadMsgs }}</ion-badge>
                      <ion-icon class="responsive-icon colored-text anim-ring" name="notifications"></ion-icon>
                    </a>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-header>
        </ion-card>
      </div>

      <!-- ALERTS SECTION -->
      <!-- <div class="masonry-item" style="position: relative;" *ngIf="shownDashboardSections.includes('dashboardAlerts')">
        <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
          <ion-icon name="move" class="handle"></ion-icon>
        </div>
        <ion-card no-margin>
          <ion-card-content>
            <ion-slides [pager]="true" [options]="alertSliderOptions">
              <ion-slide>
                <p>Mohamad, you have 5 classes today, 3 of them passed.</p>
              </ion-slide>
              <ion-slide>
                <p>Be careful, You have two modules with low attendance</p>
              </ion-slide>
              <ion-slide>
                <p>Also, your visa will expire soon :( You may need to review the immegration office</p>
              </ion-slide>
              <ion-slide>
                <p>Don't forget to pay the outstanding that you have</p>
              </ion-slide>
            </ion-slides>
          </ion-card-content>
        </ion-card>
      </div> -->

      <!-- QUICK ACCESS SECTION -->
      <div class="masonry-item no-padding">
        <ion-grid no-padding>
          <ion-row>
            <!-- QUICK ACCESS ITEM: ATTENDANCE -->
            <ion-col padding-start *ngIf="shownDashboardSections.includes('quickAccess')">
              <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
                <ion-icon name="move" class="handle"></ion-icon>
              </div>
              <quick-access-item icon="alarm" titleFirstWord='Overall' titleSecondWord='Attendance'
                [observable$]='overallAttendancePercent$' outputMode='percentage'>
              </quick-access-item>
            </ion-col>

            <!-- QUICK ACCESS ITEM: APCARD BALANCE -->
            <ion-col *ngIf="shownDashboardSections.includes('quickAccess')">
              <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
                <ion-icon name="move" class="handle"></ion-icon>
              </div>
              <quick-access-item icon="card" titleFirstWord='APCard' titleSecondWord='Balance' [observable$]='balance$'
                outputMode='currency'>
              </quick-access-item>
            </ion-col>

            <!-- QUICK ACCESS ITEM: TOTAL OVERDUE -->
            <ion-col padding-end *ngIf="shownDashboardSections.includes('quickAccess')">
              <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
                <ion-icon name="move" class="handle"></ion-icon>
              </div>
              <quick-access-item icon="logo-usd" titleFirstWord='Total' titleSecondWord='Overdue'
                [observable$]="totalOverdue$" outputMode='currency'>
              </quick-access-item>
            </ion-col>

          </ion-row>
        </ion-grid>
      </div>

      <!-- TODAY'S SCHEDULE -->
      <div class="masonry-item" *ngIf="shownDashboardSections.includes('todaysSchedule')">
        <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
          <ion-icon name="move" class="handle"></ion-icon>
        </div>
        <dashboard-card [cardTitle]='todaysScheduleCardConfigurations.cardTitle'
          [cardSubtitle]='todaysScheduleCardConfigurations.cardSubtitle'
          [withOptionsButton]='todaysScheduleCardConfigurations.withOptionsButton'
          [options]='todaysScheduleCardConfigurations.options'>
          <events-list [observable$]="todaysSchedule$"></events-list>
        </dashboard-card>
      </div>

      <!-- UPCOMING EVENTS -->
      <div class="masonry-item" *ngIf="shownDashboardSections.includes('upcomingEvents')">
        <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
          <ion-icon name="move" class="handle"></ion-icon>
        </div>
        <dashboard-card style="width: 100%;" [cardTitle]='upcomingEventsCardConfigurations.cardTitle'
          [cardSubtitle]='upcomingEventsCardConfigurations.cardSubtitle'
          [withOptionsButton]='upcomingEventsCardConfigurations.withOptionsButton'
          [options]='upcomingEventsCardConfigurations.options'>
          <events-list [observable$]="upcomingEvent$"></events-list>
        </dashboard-card>
      </div>

      <!-- APCard Transactions -->
      <div *ngIf="shownDashboardSections.includes('apcard')">
        <div class="masonry-item" *ngIf="apcardTransaction$ | async; else loadingApcardTransactions">
          <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
            <ion-icon name="move" class="handle"></ion-icon>
          </div>
          <dashboard-card [cardTitle]='apcardTransactionsCardConfigurations.cardTitle'
            [cardSubtitle]='currentBalance !== -1 ? "Balance: " + (currentBalance | currency: "MYR": "RM"): "Balance: --"'
            [options]='apcardTransactionsCardConfigurations.options'
            [contentPadding]='apcardTransactionsCardConfigurations.contentPadding'
            [withOptionsButton]='apcardTransactionsCardConfigurations.withOptionsButton'>
            <chart height="600" *ngIf="apcardChart.data" [type]="apcardChart.type" [data]="apcardChart.data"
              [options]="apcardChart.options">
            </chart>
          </dashboard-card>
        </div>
        <ng-template #loadingApcardTransactions>
          loading the apcard section
        </ng-template>
      </div>

      <!-- CGPA -->
      <div *ngIf="shownDashboardSections.includes('cgpa')">
        <div class="masonry-item" *ngIf="cgpaPerIntake$ | async; else loadingCgpaPerIntake">
          <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
            <ion-icon name="move" class="handle"></ion-icon>
          </div>
          <dashboard-card [cardTitle]='cgpaCardConfigurations.cardTitle'
            [cardSubtitle]='"Overall: " + (overallCgpa | number: "1.0-2")'
            [contentPadding]='cgpaCardConfigurations.contentPadding'
            [withOptionsButton]='cgpaCardConfigurations.withOptionsButton'>
            <chart *ngIf="cgpaChart.data" [type]="cgpaChart.type" [data]="cgpaChart.data" [options]="cgpaChart.options">
            </chart>
          </dashboard-card>
        </div>
        <ng-template #loadingCgpaPerIntake>
          loading the cgpa section
        </ng-template>
      </div>


      <!-- BUS SHUTTLE SERVICES -->
      <div *ngIf="shownDashboardSections.includes('busShuttleServices')">
        <div class="masonry-item">
          <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
            <ion-icon name="move" class="handle"></ion-icon>
          </div>
          <dashboard-card [cardTitle]='busCardConfigurations.cardTitle'
            [contentPadding]='busCardConfigurations.contentPadding'
            [withOptionsButton]='busCardConfigurations.withOptionsButton'>
            <ng-container *ngIf="(upcomingTrips$ | async) as upcomingTrips; else loadingTrips">
              <ng-container *ngIf="!showSetLocationsSettings; else locationsSettings">
                <ng-container *ngIf="upcomingTrips.length > 0; else noTrips">
                  <ion-card class="trip-card" no-margin margin-bottom *ngFor="let upcomingTrip of upcomingTrips">
                    <ion-card-content no-padding>
                      <ion-grid no-padding>
                        <ion-row>
                          <ion-col no-padding size="1">
                            <div class="full-background" [style.background]="upcomingTrip.trip_from_color"></div>
                          </ion-col>
                          <ion-col size="11" padding>
                            <h3 class="trips-locations text-bolder">{{ upcomingTrip.trip_from }} <ion-icon
                                name="arrow-dropright">
                              </ion-icon> {{upcomingTrip.trip_to}}</h3>
                            <p>
                              <span class="trip-time" [style.color]="upcomingTrip.trip_from_color"
                                *ngIf="upcomingTrip.times[0]"> {{upcomingTrip.times[0]}}
                              </span>
                              <span class="trip-time" *ngIf="upcomingTrip.times[1]"> {{upcomingTrip.times[1]}}
                              </span>
                              <span class="trip-time" *ngIf="upcomingTrip.times[2]"> {{upcomingTrip.times[2]}}
                              </span>
                              <span class="trip-time" *ngIf="upcomingTrip.times[3]">
                                {{upcomingTrip.times[3]}} </span>
                            </p>
                          </ion-col>
                        </ion-row>
                      </ion-grid>
                    </ion-card-content>
                  </ion-card>
                </ng-container>
                <ng-template #noTrips>
                  <app-message-with-svg
                    messageTitle="No More Trips!"
                    messageContent="No more trips for the selected line."
                    imageUrl="assets/img/sad.svg"
                    wrapperOffset="3"
                    wrapperSize="6">
                  </app-message-with-svg>
                </ng-template>
              </ng-container>
              <ng-template #locationsSettings>
                <app-message-with-svg
                  messageTitle="Section is not configured!"
                  messageContent="You can configure this section from the settings page, under the bus shuttle services card."
                  imageUrl="assets/img/config.svg"
                  wrapperOffset="3"
                  wrapperSize="6">
                </app-message-with-svg>
              </ng-template>

            </ng-container>
            <ng-template #loadingTrips>
              loading the trips section
            </ng-template>
          </dashboard-card>
        </div>

      </div>


      <!-- FINANCIALS -->
      <div *ngIf="shownDashboardSections.includes('financials')">
        <div class="masonry-item" *ngIf="financial$ | async as financialSummary; else loadingFinancials">
          <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
            <ion-icon name="move" class="handle"></ion-icon>
          </div>
          <dashboard-card [cardTitle]='financialsCardConfigurations.cardTitle'
            [cardSubtitle]='"Overdue: " + (financialSummary[0].TOTAL_OVERDUE | currency: "MYR": "RM")'
            [contentPadding]='financialsCardConfigurations.contentPadding'
            [withOptionsButton]='financialsCardConfigurations.withOptionsButton'>
            <chart *ngIf="financialsChart.data" [type]="financialsChart.type" [data]="financialsChart.data"
              [options]="financialsChart.options">
            </chart>
          </dashboard-card>
        </div>
        <ng-template #loadingFinancials>
          loading the financials section
        </ng-template>
      </div>

      <!-- LOW ATTENDANCE -->
      <div *ngIf="shownDashboardSections.includes('lowAttendance')">
        <div class="masonry-item" *ngIf="modulesWithLowAttendance$ | async; else loadingAttendance">
          <div [class.edit-overlay]="editableList" [class.hide]="!editableList">
            <ion-icon name="move" class="handle"></ion-icon>
          </div>
          <dashboard-card *ngIf="overallAttendancePercent$ | async as overallAttendancePercent"
            [cardTitle]='lowAttendanceCardConfigurations.cardTitle'
            [cardSubtitle]='"Overall: " + (overallAttendancePercent.value | number: "1.0-1") + "%"'
            [contentPadding]='lowAttendanceCardConfigurations.contentPadding'
            [withOptionsButton]='lowAttendanceCardConfigurations.withOptionsButton'>
            <chart *ngIf="lowAttendanceChart.data" [type]="lowAttendanceChart.type" [data]="lowAttendanceChart.data"
              [options]="lowAttendanceChart.options">
            </chart>
          </dashboard-card>
        </div>
        <ng-template #loadingAttendance>
          loading the attendance section
        </ng-template>
      </div>
    </div>
  </div>

</ion-content>
