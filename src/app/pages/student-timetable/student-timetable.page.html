<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" [hidden]='comingFromTabs() ? true : false'></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button *ngIf="intakeSelectable" fill="outline" size="small" (click)="presentIntakeSearch()"
        class="colored-text colored-border">
        {{ intake || 'Intakes' }}
      </ion-button>
      <ion-button fill="outline" size="small" (click)="view_hideToolbar()" class="colored-text colored-border">
        View
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar *ngIf="show2ndToolbar">
    <ion-buttons slot="start">
      <ion-button size="small" fill="outline" [class.colored-text]="viewWeek" [class.colored-border]="viewWeek">
        <ion-label>Weekly View</ion-label>
        <ion-toggle [(ngModel)]="viewWeek"></ion-toggle>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button size="small" fill="outline" (click)="chooseWeek()" [disabled]="availableWeek!.length === 0"
        class="colored-text colored-border">
        {{ ((viewWeek ? selectedWeek : selectedDate) | date) || 'Weeks' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event.target)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <ng-template #page_content>
    <!-- do not add filter pipe here as it affects loading -->
    <ng-template let-timetables [ngIf]="timetable$ | async" [ngIfElse]="loading">
      <ng-template let-timetables
        [ngIf]="!viewWeek ? (timetables | classes:intake:room | theday:selectedDate) : (timetables | classes:intake:room | theweek:selectedWeek)"
        [ngIfElse]="loading">
        <ng-template [ngIf]="timetables!.length" [ngIfElse]="empty">
          <ng-template [ngIf]="!viewWeek && availableWeek!.length > 0">
            <ion-segment padding [ngModel]="selectedDate | date:'E' | uppercase"
              (ngModelChange)="selectedDate = availableDate[availableDays.indexOf($event)]">
              <ion-segment-button *ngFor="let day of availableDays" [value]="day">
                {{ day }}
              </ion-segment-button>
            </ion-segment>
          </ng-template>
          <ng-template [ngIf]="selectedDate">
            <ion-grid>
              <ion-row>
                <ion-col size="6" offset="3" class="text-center">
                  <img class="rounded img-fluid printLogo" src="assets/img/login.png" alt="APU Logo">
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="6">
                  <span class="printIntake">
                    Selected Intake : {{ intake || 'Intakes' }}
                  </span>
                </ion-col>
                <ion-col size="4" offset="2" class="selectedweek">
                  Selected Week : {{ ((viewWeek ? selectedWeek : selectedDate) | date) || 'Weeks' }}
                </ion-col>
              </ion-row>
            </ion-grid>

            <ion-card class="table-top" no-padding>
              <ion-card-content no-padding>
                <ion-grid no-margin no-padding>

                  <div *ngIf="viewWeek; else viewDaily">
                    <ion-row>

                      <ion-col class="hide-on-print-flex-on-screen" size="12" size-sm="2">
                        <h2 class="print-no-margin text-bold print-font md-text-center">Module</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="2">
                        <h2 class="print-no-margin text-bold print-font md-text-center">Date</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="2" >
                        <h2 class="print-less-width print-no-margin text-bold print-font md-text-center">Time</h2>
                      </ion-col>
                      <ion-col class="flex-on-print-hide-on-screen" size="12" size-sm="2">
                        <h2 class="print-no-margin text-bold print-font md-text-center">Module</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="3">
                        <h2 class="print-no-margin text-bold print-font md-text-center">Location</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="3">
                        <h2 class="print-no-margin text-bold print-font md-text-center">Lecturer</h2>
                      </ion-col>
                    </ion-row>
                  </div>
                  <ng-template #viewDaily>
                    <ion-row>
                      <ion-col padding-start size="12" size-sm="3">
                        <h2>Module</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="3">
                        <h2 class="time">Time</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="3">
                        <h2>Location</h2>
                      </ion-col>
                      <ion-col size="12" size-sm="3">
                        <h2>Lecturer</h2>
                      </ion-col>
                    </ion-row>
                  </ng-template>
                </ion-grid>
              </ion-card-content>
            </ion-card>
          </ng-template>

          <ion-card *ngFor="let timetable of timetables; trackBy: trackByIndex" no-padding class="card-side"
            [style.borderLeft]="'1rem solid ' + strToColor(timetable.MODID)">
            <ion-card-content no-padding>
              <ion-grid>
                <div *ngIf="viewWeek; else viewDaily">
                  <ion-row>
                    <ion-col size="12" size-sm="2" class="hide-on-print-flex-on-screen ion-no-padding print-font md-text-center">
                      {{ timetable.MODID }}
                    </ion-col>
                    <ion-col size="12" size-sm="2" class="ion-no-padding print-font md-text-center">
                      <span class="marker">
                        <ion-icon name="calendar"></ion-icon>
                      </span>
                      {{ timetable.DATESTAMP_ISO | date: "EEE, d MMM " }}
                    </ion-col>
                    <ion-col size="12" size-sm="2" class="print-less-width ion-no-padding print-font  md-text-center ">
                      <span class="marker">
                        <ion-icon name="time"></ion-icon>
                      </span>
                      {{ timetable.TIME_FROM }} - {{ timetable.TIME_TO }}
                    </ion-col>
                    <ion-col size="12" size-sm="2" class="flex-on-print-hide-on-screen ion-no-padding print-font md-text-center">
                      {{ timetable.MODID }}
                    </ion-col>
                    <ion-col size="12" size-sm="3" class="ion-no-padding print-font md-text-center">
                      <span class="marker">
                        <ion-icon name="locate"></ion-icon>
                      </span>
                      {{ timetable.ROOM }} | {{ timetable.LOCATION }}
                    </ion-col>
                    <ion-col size="12" size-sm="3" class="ion-no-padding">
                      <a [routerLink]="['/staffs', timetable.SAMACCOUNTNAME]"
                        class="colored-text printColor print-font md-text-center">
                        <span class="marker">
                          <ion-icon name="contact"></ion-icon>
                        </span>
                        {{ timetable.NAME }}
                      </a>
                    </ion-col>
                  </ion-row>
                </div>

                <ng-template #viewDaily>
                  <ion-row>
                    <ion-col size="12" size-sm="3">
                      {{ timetable.MODID }}
                    </ion-col>
                    <ion-col size="12" size-sm="3">
                      <span class="marker">
                        <ion-icon name="time"></ion-icon>
                      </span>
                      {{ timetable.TIME_FROM }} - {{ timetable.TIME_TO }}
                    </ion-col>
                    <ion-col size="12" size-sm="3">
                      <span class="marker">
                        <ion-icon name="locate"></ion-icon>
                      </span>
                      {{ timetable.ROOM }} | {{ timetable.LOCATION }}
                    </ion-col>
                    <ion-col size="12" size-sm="3">
                      <a [routerLink]="['/staffs', timetable.SAMACCOUNTNAME]" class="colored-text">
                        <span class="marker">
                          <ion-icon name="contact"></ion-icon>
                        </span>
                        {{ timetable.NAME }}
                      </a>
                    </ion-col>
                  </ion-row>
                </ng-template>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ng-template>
      </ng-template>

      <ng-template #empty>
        <ion-card>
          <ion-card-content>
            <ng-container *ngIf="intake; else byroom">
              <app-message-with-svg imageUrl="assets/img/happy.svg"
                messageContent="There are no classes for the selected intake on the selected week!"
                messageTitle="Hooray! No classes this week." wrapperSize="4" wrapperOffset="4" wrapperMarginTop="20px">
              </app-message-with-svg>
            </ng-container>
            <ng-template #byroom>
              <app-message-with-svg imageUrl="assets/img/no-consultations.svg"
                messageContent="We couldn't find any timetable for the selected room."
                messageTitle="No timetable found for the selected room!" wrapperSize="4" wrapperOffset="4"
                wrapperMarginTop="20px">
              </app-message-with-svg>
            </ng-template>
          </ion-card-content>
        </ion-card>
      </ng-template>

      <!-- trivial message but must be displayed -->
      <ion-grid no-padding>
        <ion-row class="legend">
          <ion-col size="12" size-sm="12" size-lg="6" no-padding>
            <ion-card class="card-special">
              <ion-card-header class="colored-border">
                <ion-card-title>Legend</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <p *ngFor="let legend of legends">
                  <b>{{ legend.name }}</b> - {{ legend.desc }}
                </p>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-sm="12" size-lg="6" no-padding>
            <ion-card class="card-special">
              <ion-card-header class="colored-border">
                <ion-card-title>Mid Year Semester</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                While there will be no classes during the mid-semester break for your
                intake, your intake time table will continue to appear during the
                break.
              </ion-card-content>
            </ion-card>
            <ion-card class="card-special">
              <ion-card-header class="colored-border">
                <ion-card-title>Important Notice</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <p>
                  Students are advised to consult your lecturers to check whether there
                  will be lectures during the buffer/revision week.
                </p>
                <p>
                  The timetable published on the buffer/revision week will be the
                  same as the last week of the semester.
                </p>
                <p>
                  If your lecturer decides not to use the buffer/revision week, then
                  you will not be required to come for lectures during the
                  buffer/revision week.
                </p>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ng-template>

    <ng-template #loading>
      <ion-card no-padding>
        <ion-card-content no-padding>
          <ion-skeleton-text animated style="width: 100%; line-height: 100px"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
      <ion-card no-padding>
        <ion-card-content no-padding>
          <ion-skeleton-text animated style="width: 100%; line-height: 100px"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
      <ion-card no-padding>
        <ion-card-content no-padding>
          <ion-skeleton-text animated style="width: 100%; line-height: 100px"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
      <ion-card no-padding>
        <ion-card-content no-padding>
          <ion-skeleton-text animated style="width: 100%; line-height: 100px"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </ng-template>
  </ng-template>

  <div class="hide-on-print">
    <ng-container *ngTemplateOutlet="page_content"></ng-container>
  </div>

</ion-content>

<div class="show-on-print">
  <ng-container *ngTemplateOutlet="page_content"></ng-container>
</div>